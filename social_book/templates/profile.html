{% extends 'main.html' %}
{% block content %}
<div class="row g-0 g-lg-4">

  <!-- LEFT SIDEBAR -->
  <div class="col-lg-3 d-none d-lg-flex flex-column">
    <div class="left-sidebar sticky-sidebar">
      <div class="sidebar-logo mb-4"><a href="{% url 'index' %}" class="text-decoration-none"><span class="fw-bold fs-3"
            style="color:var(--primary);letter-spacing:-1px;">CLiQ</span></a></div>
      <nav class="d-flex flex-column gap-1 mb-4">
        <a href="{% url 'index' %}" class="sidebar-nav-link"><i class="bi bi-house-door-fill"></i> Home</a>
        <a href="{% url 'profile' request.user.id %}" class="sidebar-nav-link active"><i
            class="bi bi-person-circle"></i> Profile</a>
        <a href="{% url 'chat' %}" class="sidebar-nav-link"><i class="bi bi-chat-dots-fill"></i> Messages</a>
        <a href="{% url 'settings' %}" class="sidebar-nav-link"><i class="bi bi-gear-fill"></i> Settings</a>
        <a href="{% url 'logout' %}" class="sidebar-nav-link text-danger"><i class="bi bi-box-arrow-right"></i> Log
          Out</a>
      </nav>
    </div>
  </div>

  <!-- PROFILE CONTENT -->
  <div class="col-lg-9">
    <!-- Banner + Avatar -->
    <div class="profile-banner modern-card mb-4"
      style="background-image:url('{{ user_id.backgroundImage.url }}');background-size:cover;background-position:center;min-height:220px;position:relative;">
      <div class="profile-banner-overlay d-flex align-items-end p-4"
        style="background:linear-gradient(to top, rgba(0,0,0,0.65) 0%, transparent 60%);min-height:220px;border-radius:var(--radius);">
        <div class="d-flex align-items-end gap-4 w-100 flex-wrap">
          <div class="avatar-ring-lg"><img src="{{ user_id.avatar.url }}" width="96" height="96" class="avatar-img-lg"
              alt="{{ user_id.username }}"></div>
          <div class="flex-grow-1 text-white">
            <h4 class="fw-bold m-0">@{{ user_id.username }}</h4>
            {% if user_id.location %}<small class="opacity-75"><i class="bi bi-geo-alt me-1"></i>
              {{ user_id.location }}</small>
            {% endif %}
          </div>
          <div class="d-flex gap-3 text-white text-center flex-wrap">
            <div>
              <div class="fw-bold fs-5">{{ user_posts.count }}</div><small class="opacity-75">Posts</small>
            </div>
            <div>
              <div class="fw-bold fs-5">{{ followed_count }}</div><small class="opacity-75">Followers</small>
            </div>
            <div>
              <div class="fw-bold fs-5">{{ following_count }}</div><small class="opacity-75">Following</small>
            </div>
          </div>
          {% if request.user.id != user_id.id %}
          <a href="{% url 'follow' user_id.id %}"
            class="{% if follow_filter %}btn btn-modern{% else %}btn btn-outline-modern{% endif %}"
            style="border-color:#fff;color:{% if follow_filter %}#fff{% else %}#fff{% endif %};">
            {% if follow_filter %}
            Following
            {% else %}
            Follow
            {% endif %}
          </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Bio -->
    {% if user_id in takip_ettiklerim_kullanicilar or request.user == user_id %}
    {% if user_id.bio %}
    <div class="modern-card p-4 mb-4">
      <h6 class="fw-bold text-muted mb-2" style="font-size:0.75rem;letter-spacing:0.08em;text-transform:uppercase;">Bio
      </h6>
      <p class="m-0" style="font-size:0.95rem;">{{ user_id.bio }}</p>
    </div>
    {% endif %}

    <!-- Update post button -->
    {% if request.user == user_id %}
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h6 class="fw-bold m-0">Posts</h6>
      <button class="btn btn-modern btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="bi bi-plus-circle me-1"></i>New Post</button>
    </div>
    {% else %}
    <h6 class="fw-bold mb-4">Posts</h6>
    {% endif %}

    <!-- Posts Grid -->
    <div class="row g-3">
      {% for user_post in user_posts %}
      <div class="col-md-6 col-lg-4">
        <div class="modern-card overflow-hidden" style="cursor:pointer;">
          {% if user_post.image %}<img src="{{ user_post.image.url }}" class="w-100"
            style="height:220px;object-fit:cover;" alt="post">
          {% endif %}
          <div class="p-3">
            <p class="small m-0 text-muted text-truncate">{{ user_post.caption }}</p>
            <div class="d-flex align-items-center justify-content-between mt-2">
              <span class="small fw-bold"><i class="bi bi-heart-fill text-danger me-1"></i>
                {{user_post.people_who_liked.all.count }}</span>
              {% if request.user == user_post.user %}<a href="{% url 'post-delete' user_post.id %}"
                class="btn btn-link text-danger p-0" style="font-size:0.8rem;"><i class="bi bi-trash3"></i></a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    {% else %}
    <div class="modern-card p-5 text-center">
      <i class="bi bi-lock text-muted display-4 mb-3"></i>
      <h5 class="fw-bold">Follow to see posts</h5>
      <p class="text-muted small">Follow this account to see their posts.</p>
      {% if request.user.id != user_id.id %}
      <a href="{% url 'follow' user_id.id %}" class="btn btn-modern mt-2">Follow</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-card border-0">
      <div class="modal-header border-0 pb-2">
        <h5 class="modal-title fw-bold">New Post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="{% url 'upload' %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-body pt-0">
          <div class="mb-3"><input type="file" name="image_upload" class="form-control rounded-3"></div>
          <textarea name="caption" class="form-control rounded-3" rows="3" placeholder="Write a caption..."></textarea>
        </div>
        <div class="modal-footer border-0 pt-0">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-modern btn-sm">Share</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .avatar-ring-lg {
    padding: 3px;
    background: linear-gradient(135deg, #6366f1 0%, #a855f7 55%, #ec4899 100%);
    border-radius: 50%;
    display: inline-flex;
  }

  .avatar-img-lg {
    border: 3px solid #fff;
    border-radius: 50%;
    object-fit: cover;
    display: block;
  }

  .profile-banner {
    overflow: hidden;
  }
</style>
{% endblock %}