{% extends 'main.html' %}
{% block content %}
<div class="row g-0 g-lg-4">
    <!-- LEFT SIDEBAR -->
    <div class="col-lg-3 d-none d-lg-flex flex-column">
        <div class="left-sidebar sticky-sidebar">
            <div class="sidebar-logo mb-4"><a href="{% url 'index' %}" class="text-decoration-none"><span
                        class="fw-bold fs-3" style="color:var(--primary);letter-spacing:-1px;">CLiQ</span></a></div>
            <nav class="d-flex flex-column gap-1 mb-4">
                <a href="{% url 'index' %}" class="sidebar-nav-link"><i class="bi bi-house-door-fill"></i> Home</a>
                <a href="{% url 'profile' request.user.id %}" class="sidebar-nav-link"><i
                        class="bi bi-person-circle"></i> Profile</a>
                <a href="{% url 'chat' %}" class="sidebar-nav-link active"><i class="bi bi-chat-dots-fill"></i>
                    Messages</a>
                <a href="{% url 'settings' %}" class="sidebar-nav-link"><i class="bi bi-gear-fill"></i> Settings</a>
                <a href="{% url 'logout' %}" class="sidebar-nav-link text-danger"><i class="bi bi-box-arrow-right"></i>
                    Log Out</a>
            </nav>
        </div>
    </div>

    <!-- CHAT WINDOW -->
    <div class="col-lg-6">
        <div class="modern-card overflow-hidden mt-2">
            <!-- Chat Header -->
            <div class="p-3 d-flex align-items-center gap-3 border-bottom"
                style="border-color:rgba(0,0,0,0.06)!important;">
                <a href="{% url 'chat' %}" class="btn btn-link text-dark p-0"><i class="bi bi-arrow-left fs-5"></i></a>
                <a href="{% url 'profile' chat_user.id %}"
                    class="d-flex align-items-center gap-2 text-decoration-none flex-grow-1">
                    <div class="avatar-ring"><img src="{{ chat_user.avatar.url }}" width="36" height="36"
                            class="avatar-img"></div>
                    <span class="fw-bold text-dark">@{{ chat_user }}</span>
                </a>
            </div>

            <!-- Messages -->
            <div id="chat-content" style="height:360px;overflow-y:auto;padding:16px;background:rgba(241,245,249,0.5);">
                {% for chat in chats %}
                {% if request.user == chat.user1 %}
                <div class="d-flex justify-content-end mb-3">
                    <div class="d-flex align-items-end gap-2">
                        <div class="chat-bubble-out px-3 py-2">{{ chat.chat }}</div>
                        <img src="{{ user_profile.avatar.url }}" width="26" height="26"
                            class="rounded-circle flex-shrink-0" style="object-fit:cover;">
                    </div>
                </div>
                {% else %}
                <div class="d-flex justify-content-start mb-3">
                    <div class="d-flex align-items-end gap-2">
                        <img src="{{ chat_user.avatar.url }}" width="26" height="26"
                            class="rounded-circle flex-shrink-0" style="object-fit:cover;">
                        <div class="chat-bubble-in px-3 py-2">{{ chat.chat }}</div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!-- Input -->
            <div class="p-3 border-top" style="border-color:rgba(0,0,0,0.06)!important;">
                <form action="{% url 'chat-user' chat_user.id %}" id="chat-form" method="POST"
                    class="d-flex gap-2 align-items-center">
                    {% csrf_token %}
                    <input type="hidden" value="{{ request.user.id }}" name="firstUser">
                    <input type="hidden" value="{{ chat_user.id }}" name="lastUser">
                    <img src="{{ user_profile.avatar.url }}" width="30" height="30" class="rounded-circle flex-shrink-0"
                        style="object-fit:cover;">
                    <input type="text" class="form-control border-0 bg-light rounded-pill px-3" id="chat-input"
                        name="chat" placeholder="Write a message..." autocomplete="off">
                    <button type="submit" class="btn btn-modern px-3 py-2"><i class="bi bi-send-fill"></i></button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .chat-bubble-out {
        background: var(--primary);
        color: #fff;
        border-radius: 18px 18px 4px 18px;
        font-size: 0.9rem;
        max-width: 260px;
        word-break: break-word;
    }

    .chat-bubble-in {
        background: #fff;
        color: var(--text);
        border-radius: 18px 18px 18px 4px;
        font-size: 0.9rem;
        max-width: 260px;
        word-break: break-word;
        box-shadow: var(--shadow-sm);
    }

    #chat-content::-webkit-scrollbar {
        width: 4px;
    }

    #chat-content::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }
</style>

<script>
    function scrollToBottom() { var c = document.getElementById("chat-content"); c.scrollTop = c.scrollHeight; }
    window.onload = scrollToBottom;
    document.getElementById("chat-form").onsubmit = scrollToBottom;
</script>
{% endblock %}